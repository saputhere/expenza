<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Expense Manager - GitHub Powered</title>
<meta name="description" content="Elegant Expense Management application with GitHub authentication and data storage" />
<!-- TailwindCSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Custom overrides for Default inspiration style */
  body {
    background-color: #ffffff;
    color: #6b7280;
    font-family: 'Inter', sans-serif;
  }
  h1, h2, h3, h4 {
    color: #111827; /* dark gray/black for headlines */
    font-weight: 700;
  }
  /* Sticky header styles */
  header {
    background-color: white;
    border-bottom: 1px solid #e5e7eb;
    backdrop-filter: saturate(180%) blur(10px);
    z-index: 50;
  }
  /* Card style */
  .card {
    background-color: white;
    border-radius: 0.75rem; /* 12px */
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.1), 0 1px 2px rgb(0 0 0 / 0.06);
    transition: box-shadow 0.3s ease;
  }
  .card:hover,
  .card:focus-within {
    box-shadow: 0 4px 6px rgb(0 0 0 / 0.15), 0 2px 4px rgb(0 0 0 / 0.10);
  }
  /* Button variants */
  .btn-primary {
    background-color: #111827;
    color: white;
    font-weight: 600;
    border-radius: 0.5rem;
    padding: 0.5rem 1.5rem;
    transition: background-color 0.3s ease;
  }
  .btn-primary:hover,
  .btn-primary:focus {
    background-color: #374151;
    outline: none;
  }
  .btn-outline {
    border: 2px solid #111827;
    background-color: transparent;
    color: #111827;
    font-weight: 600;
    border-radius: 0.5rem;
    padding: 0.5rem 1.5rem;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .btn-outline:hover,
  .btn-outline:focus {
    background-color: #111827;
    color: white;
    outline: none;
  }
  /* Inputs and labels */
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #374151;
  }
  input, select, textarea {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
    color: #374151;
    outline-offset: 2px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #111827;
    box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.3);
  }
  /* Table */
  table {
    border-collapse: separate;
    border-spacing: 0 0.5rem;
    width: 100%;
  }
  th {
    text-align: left;
    padding-bottom: 0.5rem;
    font-weight: 600;
    color: #4b5563;
  }
  td {
    padding: 0.75rem 0.75rem;
  }
  tr {
    background-color: #fff;
    box-shadow: 0 1px 2px rgb(0 0 0 / 0.05);
    border-radius: 0.75rem;
  }
  tr:hover {
    box-shadow: 0 4px 6px rgb(0 0 0 / 0.10);
  }
  /* Responsive container */
  main > div.container {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }
  /* Skeleton loader */
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.4;
    }
  }
  .skeleton {
    background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%);
    background-size: 400% 100%;
    animation: pulse 1.5s ease-in-out infinite;
    border-radius: 0.5rem;
    height: 1rem;
  }
</style>
</head>
<body>
<header class="sticky top-0 shadow-sm px-6 py-4 flex justify-between items-center">
  <a href="#" class="font-extrabold text-2xl text-gray-900 select-none">ExpenseManager</a>
  <nav>
    <button id="login-btn" class="btn-primary" aria-label="Log in with GitHub">Log in with GitHub</button>
    <button id="logout-btn" class="btn-outline hidden" aria-label="Log out" title="Log out">Logout</button>
  </nav>
</header>

<main class="pt-16 pb-20">
  <div class="container">
    <section id="hero" class="text-center max-w-4xl mx-auto mb-20">
      <h1 class="text-5xl font-extrabold mb-4 leading-tight">
        Manage Your Expenses Effortlessly
      </h1>
      <p class="text-gray-600 text-lg mb-6">
        Securely login with GitHub to track your expenses. All data is stored privately in your GitHub repository.
      </p>
      <button id="add-expense-btn" class="btn-primary text-xl px-8 py-3 rounded-md shadow-md hover:shadow-lg transition-transform transform hover:scale-[1.03]" disabled>
        Add New Expense
      </button>
    </section>

    <section id="app" class="max-w-5xl mx-auto hidden" aria-live="polite" aria-label="Expense management application">
      <div id="loading" class="mb-6">
        <div class="skeleton w-64 h-6 mb-2"></div>
        <div class="skeleton w-full h-20 rounded-md"></div>
      </div>

      <div id="expense-list-section" aria-label="Expense list" class="mb-12">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Your Expenses</h2>
        <table aria-describedby="expense-list-description" role="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Category</th>
              <th class="text-right">Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="expense-list" tabindex="0">
            <!-- dynamically rendered expenses here -->
          </tbody>
        </table>
        <p id="expense-list-description" class="sr-only">List of all your tracked expenses, sorted by most recent date first.</p>
      </div>

      <section id="expense-form-section" aria-label="Add or edit expense form" class="max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-gray-800" id="form-title">Add Expense</h2>
        <form id="expense-form" novalidate>
          <input type="hidden" id="expense-id" value="" />
          <div class="mb-5">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" required aria-required="true" />
            <span class="text-red-500 mt-1 hidden" id="date-error">Please enter a valid date</span>
          </div>
          <div class="mb-5">
            <label for="description">Description</label>
            <input type="text" id="description" name="description" required placeholder="e.g. Coffee at Starbucks" aria-required="true" />
            <span class="text-red-500 mt-1 hidden" id="description-error">Description is required</span>
          </div>
          <div class="mb-5">
            <label for="category">Category</label>
            <select id="category" name="category" required aria-required="true" >
              <option value="" disabled selected>Select a category</option>
              <option>Food & Drinks</option>
              <option>Transportation</option>
              <option>Housing</option>
              <option>Entertainment</option>
              <option>Health</option>
              <option>Other</option>
            </select>
            <span class="text-red-500 mt-1 hidden" id="category-error">Please select a category</span>
          </div>
          <div class="mb-5">
            <label for="amount">Amount (USD)</label>
            <input type="number" id="amount" name="amount" min="0" step="0.01" required placeholder="e.g. 12.50" aria-required="true" />
            <span class="text-red-500 mt-1 hidden" id="amount-error">Amount must be greater than 0</span>
          </div>
          <div class="flex justify-end space-x-4">
            <button type="button" id="cancel-btn" class="btn-outline">Cancel</button>
            <button type="submit" class="btn-primary">Save Expense</button>
          </div>
        </form>
      </section>
    </section>
  </div>
</main>

<footer class="border-t border-gray-200 pt-12 pb-10 text-center text-gray-400 text-sm select-none">
  &copy; 2024 ExpenseManager. Data stored securely in your GitHub repo.
</footer>

<script>
  // Configuration: user must replace with their GitHub OAuth app client ID
  const GITHUB_CLIENT_ID = 'Ov23lixB6JciA1Mwqslu';
  const REPO_OWNER = 'saputhere';
  const REPO_NAME = 'expenza';
  const DATA_FOLDER = 'data';
  const EXPENSES_FILENAME = 'expenses.json'; // Location: data/expenses.json for all users or per user

  // Globals
  let accessToken = null;
  let user = null;
  let expenses = [];
  let shaCache = null; // For file SHA to update
  let userLogin = null;

  // DOM elements
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const appSection = document.getElementById('app');
  const loadingElem = document.getElementById('loading');
  const expenseList = document.getElementById('expense-list');
  const addExpenseBtn = document.getElementById('add-expense-btn');
  const expenseFormSection = document.getElementById('expense-form-section');
  const expenseForm = document.getElementById('expense-form');
  const formTitle = document.getElementById('form-title');
  const cancelBtn = document.getElementById('cancel-btn');

  // Utility
  function showElement(el) { el.classList.remove('hidden'); }
  function hideElement(el) { el.classList.add('hidden'); }

  // Login flow
  function buildGitHubOAuthUrl() {
    const params = new URLSearchParams({
      client_id: GITHUB_CLIENT_ID,
      scope: 'repo',
      allow_signup: 'true',
      redirect_uri: window.location.origin + window.location.pathname,
      state: 'xyz123', // Optional, could be random for CSRF protection
      response_type: 'token',
    });
    return `https://github.com/login/oauth/authorize?${params.toString()}`;
  }

  // Parse access token from URL fragment
  function getAccessTokenFromUrl() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }

  // Save token in localStorage
  function saveToken(token) {
    localStorage.setItem('github_access_token', token);
  }

  // Load token from localStorage
  function loadToken() {
    return localStorage.getItem('github_access_token');
  }

  // Remove token on logout
  function clearToken() {
    localStorage.removeItem('github_access_token');
  }

  // Fetch GitHub API with token
  async function githubApiRequest(path, options = {}) {
    const base = 'https://api.github.com';
    const url = base + path;
    const headers = options.headers || {};
    headers['Authorization'] = 'token ' + accessToken;
    headers['Accept'] = 'application/vnd.github.v3+json';
    options.headers = headers;
    const response = await fetch(url, options);
    if (response.status === 401) {
      logout();
      alert('Unauthorized. Please login again.');
      throw new Error('Unauthorized');
    }
    if (!response.ok) {
      const errorBody = await response.json().catch(() => ({}));
      throw new Error(errorBody.message || 'GitHub API error');
    }
    return response.json();
  }

  // Get the authenticated user's login
  async function fetchUser() {
    const data = await githubApiRequest('/user');
    userLogin = data.login;
    return data;
  }

  // Calculate the path for user's expenses file
  function getExpensesFilePath() {
    // Store expenses per user inside data/{username}-expenses.json
    return `/${DATA_FOLDER}/${userLogin}-expenses.json`;
  }

  // Fetch user's expenses file contents & SHA (for update)
  async function fetchExpenses() {
    const path = getExpensesFilePath().substring(1); // Remove leading slash for API
    try {
      const fileData = await githubApiRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`);
      shaCache = fileData.sha;
      const decodedContent = atob(fileData.content);
      expenses = JSON.parse(decodedContent);
    } catch (err) {
      // If file not found, initialize empty array
      if (err.message.includes('Not Found')) {
        expenses = [];
        shaCache = null;
      } else {
        throw err;
      }
    }
  }

  // Commit expenses JSON file update
  async function commitExpenses() {
    const path = getExpensesFilePath().substring(1);
    const contentEncoded = btoa(JSON.stringify(expenses, null, 2));
    const message = expenses.length === 0 ? 'Clear expenses data' : 'Update expenses data â€” via ExpenseManager app';
    const body = {
      message: message,
      content: contentEncoded,
      branch: 'main',
    };
    if (shaCache) {
      body.sha = shaCache;
    }
    const response = await githubApiRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`), {
      method: 'PUT',
      body: JSON.stringify(body),
      headers: {'Content-Type': 'application/json'}
    });
    shaCache = response.content.sha;
  }

  // Format amount with 2 decimals and dollar sign
  function formatAmount(value) {
    return '$' + Number(value).toFixed(2);
  }

  // Format ISO date as YYYY-MM-DD
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    return d.toISOString().split('T')[0];
  }

  // Render expense list table rows
  function renderExpenses() {
    if (!expenses.length) {
      expenseList.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400 py-10">No expenses yet. Add your first expense!</td></tr>';
      return;
    }
    // Sort descending by date
    expenses.sort((a, b) => (b.date.localeCompare(a.date)));
    expenseList.innerHTML = expenses.map((expense, idx) => {
      return \`
      <tr tabindex="0" aria-label="Expense on \${expense.date} for \${expense.description} amount \${formatAmount(expense.amount)} category \${expense.category}">
        <td>\${formatDate(expense.date)}</td>
        <td>\${escapeHtml(expense.description)}</td>
        <td>\${escapeHtml(expense.category)}</td>
        <td class="text-right font-semibold">\${formatAmount(expense.amount)}</td>
        <td>
          <button class="text-indigo-600 hover:text-indigo-900 font-semibold mr-2" data-action="edit" data-index="\${idx}" aria-label="Edit expense \${escapeHtml(expense.description)}">Edit</button>
          <button class="text-red-600 hover:text-red-900 font-semibold" data-action="delete" data-index="\${idx}" aria-label="Delete expense \${escapeHtml(expense.description)}">Delete</button>
        </td>
      </tr>
      \`;
    }).join('');
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
    }[m]));
  }

  // Reset form fields and state
  function resetForm() {
    expenseForm.reset();
    expenseForm['expense-id'].value = '';
    formTitle.textContent = 'Add Expense';
    hideValidationErrors();
  }

  // Show validation errors
  function showValidationError(fieldId, message) {
    const errorSpan = document.getElementById(\`\${fieldId}-error\`);
    if (!errorSpan) return;
    errorSpan.textContent = message;
    errorSpan.classList.remove('hidden');
  }

  // Hide all validation errors
  function hideValidationErrors() {
    ['date','description','category','amount'].forEach(id => {
      const err = document.getElementById(\`\${id}-error\`);
      if (err) err.classList.add('hidden');
    });
  }

  // Form validation
  function validateForm() {
    hideValidationErrors();
    let valid = true;
    // Date required and valid
    const dateVal = expenseForm.date.value.trim();
    if (!dateVal) {
      showValidationError('date', 'Please enter a valid date');
      valid = false;
    }
    // Description non-empty
    if (!expenseForm.description.value.trim()) {
      showValidationError('description', 'Description is required');
      valid = false;
    }
    // Category selected
    if (!expenseForm.category.value) {
      showValidationError('category', 'Please select a category');
      valid = false;
    }
    // Amount positive number > 0
    const amt = parseFloat(expenseForm.amount.value);
    if (isNaN(amt) || amt <= 0) {
      showValidationError('amount', 'Amount must be greater than 0');
      valid = false;
    }
    return valid;
  }

  // Add or update expense in array
  function saveExpense() {
    const id = expenseForm['expense-id'].value;
    const newExpense = {
      date: expenseForm.date.value,
      description: expenseForm.description.value.trim(),
      category: expenseForm.category.value,
      amount: parseFloat(expenseForm.amount.value).toFixed(2),
    };
    if (id) {
      // Editing existing - replace by index
      expenses[Number(id)] = newExpense;
    } else {
      expenses.push(newExpense);
    }
  }

  // Handle form submit event
  async function onFormSubmit(e) {
    e.preventDefault();
    if (!validateForm()) return;
    // Disable form controls during save
    disableForm(true);
    try {
      saveExpense();
      await commitExpenses();
      renderExpenses();
      resetForm();
      expenseFormSection.scrollIntoView({behavior:'smooth'});
    } catch (err) {
      alert('Failed to save expense: ' + err.message);
    } finally {
      disableForm(false);
    }
  }

  // Disable or enable form inputs and buttons
  function disableForm(disable) {
    [...expenseForm.elements].forEach(el => {
      el.disabled = disable;
    });
    addExpenseBtn.disabled = disable;
  }

  // Handle click on edit/delete buttons in expense list
  function onExpenseListClick(e) {
    const target = e.target;
    if (target.tagName.toLowerCase() !== 'button') return;
    const action = target.dataset.action;
    const index = parseInt(target.dataset.index, 10);
    if (isNaN(index)) return;
    if (action === 'edit') {
      editExpense(index);
    } else if (action === 'delete') {
      deleteExpense(index);
    }
  }

  // Prefill form for editing an expense
  function editExpense(index) {
    const exp = expenses[index];
    expenseForm['expense-id'].value = index;
    expenseForm.date.value = formatDate(exp.date);
    expenseForm.description.value = exp.description;
    expenseForm.category.value = exp.category;
    expenseForm.amount.value = exp.amount;
    formTitle.textContent = 'Edit Expense';
    expenseFormSection.scrollIntoView({behavior:'smooth'});
  }

  // Delete expense with confirmation
  async function deleteExpense(index) {
    if (!confirm('Are you sure you want to delete this expense?')) return;
    expenses.splice(index, 1);
    try {
      await commitExpenses();
      renderExpenses();
    } catch (err) {
      alert('Failed to delete expense: ' + err.message);
    }
  }

  // Initiate login process via GitHub OAuth redirect
  function login() {
    if (GITHUB_CLIENT_ID === 'YOUR_GITHUB_OAUTH_CLIENT_ID_HERE' || !GITHUB_CLIENT_ID) {
      alert('You must set your GitHub OAuth client ID in the script before logging in.');
      return;
    }
    const authUrl = buildGitHubOAuthUrl();
    // Redirect browser to GitHub OAuth login page
    window.location.href = authUrl;
  }

  // Logout user
  function logout() {
    accessToken = null;
    user = null;
    userLogin = null;
    clearToken();
    loginBtn.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    appSection.classList.add('hidden');
    addExpenseBtn.disabled = true;
  }

  // Initialize after login - fetch user info, data file, render UI
  async function postLoginSetup(token) {
    accessToken = token;
    saveToken(token);
    try {
      user = await fetchUser();
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      appSection.classList.remove('hidden');
      addExpenseBtn.disabled = false;
      await fetchExpenses();
      renderExpenses();
    } catch (err) {
      logout();
      alert('Error during GitHub API access: ' + err.message);
    } finally {
      hideElement(loadingElem);
    }
  }

  // On page load, check access token from URL or localStorage
  async function initialize() {
    hideElement(appSection);
    showElement(loadingElem);

    // Check if access_token in URL fragment
    const urlAccessToken = getAccessTokenFromUrl();
    if (urlAccessToken) {
      // Clean URL
      history.replaceState(null, '', window.location.pathname);
      await postLoginSetup(urlAccessToken);
      return;
    }

    // Check localStorage token
    const storedToken = loadToken();
    if (storedToken) {
      await postLoginSetup(storedToken);
      return;
    }

    // Not logged in
    hideElement(loadingElem);
    loginBtn.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    addExpenseBtn.disabled = true;
  }

  // Event Listeners
  loginBtn.addEventListener('click', login);
  logoutBtn.addEventListener('click', logout);

  addExpenseBtn.addEventListener('click', () => {
    resetForm();
    expenseFormSection.scrollIntoView({behavior: 'smooth'});
  });

  expenseForm.addEventListener('submit', onFormSubmit);
  cancelBtn.addEventListener('click', (e) => {
    e.preventDefault();
    resetForm();
  });

  expenseList.addEventListener('click', onExpenseListClick);

  // Run initialize on page load
  window.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>

